<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Gestion Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .creneau {
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .day-schedule {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: #f8f9fa;
  }
  .alert {
    margin-top: 1rem;
  }
  .loading {
    display: none;
  }
</style>
</head>
<body class="container mt-4">

<h1>Gestion Admin</h1>

<!-- Alert pour les messages -->
<div id="alert-container"></div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Cr√©er un nouvel utilisateur</h5>
  </div>
  <div class="card-body">
    <form id="userForm" method="POST" class="mb-4">
        <div class="mb-3">
            <label for="role" class="form-label">Type *</label>
            <select id="role" name="role" class="form-select" required>
                <option value="" selected disabled>Choisissez un r√¥le</option>
                <option value="patient">Patient</option>
                <option value="medecin">M√©decin</option>
            </select>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="nom" class="form-label">Nom *</label>
                    <input type="text" id="nom" name="nom" class="form-control" required />
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="prenom" class="form-label">Pr√©nom *</label>
                    <input type="text" id="prenom" name="prenom" class="form-control" required />
                </div>
            </div>
        </div>

        <!-- Num√©ro t√©l√©phone patient -->
        <div class="mb-3" id="numero-div" style="display:none;">
            <label for="numero" class="form-label">Num√©ro de t√©l√©phone *</label>
            <input type="tel" id="numero" name="numero" class="form-control"
                   placeholder="+212 600 123 456" pattern="[+]?[0-9\s\-]+" />
            <div class="form-text">Format: +212 600 123 456</div>
        </div>

        <!-- Sp√©cialit√© m√©decin -->
        <div class="mb-3" id="specialite-div" style="display:none;">
            <label for="specialite" class="form-label">Sp√©cialit√© *</label>
            <input type="text" id="specialite" name="specialite" class="form-control"
                   placeholder="Ex: Cardiologie, P√©diatrie, Neurologie..." />
        </div>

        <!-- Horaires m√©decin -->
        <div class="mb-3" id="horaires-div" style="display:none;">
            <label class="form-label"><strong>Horaires disponibles</strong></label>
            <div class="form-text mb-3">D√©finissez les cr√©neaux de disponibilit√© pour chaque jour. Vous pouvez ajouter plusieurs cr√©neaux par jour.</div>

            <div data-day="lundi" class="day-schedule mb-3">
              <strong>üóìÔ∏è Lundi</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="lundi_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="lundi_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('lundi')">+ Ajouter un cr√©neau</button>
            </div>

            <div data-day="mardi" class="day-schedule mb-3">
              <strong>üóìÔ∏è Mardi</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="mardi_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="mardi_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('mardi')">+ Ajouter un cr√©neau</button>
            </div>

            <div data-day="mercredi" class="day-schedule mb-3">
              <strong>üóìÔ∏è Mercredi</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="mercredi_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="mercredi_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('mercredi')">+ Ajouter un cr√©neau</button>
            </div>

            <div data-day="jeudi" class="day-schedule mb-3">
              <strong>üóìÔ∏è Jeudi</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="jeudi_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="jeudi_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('jeudi')">+ Ajouter un cr√©neau</button>
            </div>

            <div data-day="vendredi" class="day-schedule mb-3">
              <strong>üóìÔ∏è Vendredi</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="vendredi_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="vendredi_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('vendredi')">+ Ajouter un cr√©neau</button>
            </div>

            <div data-day="samedi" class="day-schedule mb-3">
              <strong>üóìÔ∏è Samedi</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="samedi_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="samedi_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('samedi')">+ Ajouter un cr√©neau</button>
            </div>

            <div data-day="dimanche" class="day-schedule mb-3">
              <strong>üóìÔ∏è Dimanche</strong>
              <div class="creneaux mt-2">
                <div class="creneau">
                  <input type="time" name="dimanche_start[]" class="form-control form-control-sm">
                  <span>√†</span>
                  <input type="time" name="dimanche_end[]" class="form-control form-control-sm">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCreneau('dimanche')">+ Ajouter un cr√©neau</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="email" class="form-label">Email *</label>
                    <input type="email" id="email" name="email" class="form-control" required />
                    <div class="form-text">Cet email servira d'identifiant de connexion</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="mot_de_passe" class="form-label">Mot de passe *</label>
                    <input type="password" id="mot_de_passe" name="mot_de_passe" class="form-control"
                           required minlength="6" />
                    <div class="form-text">Minimum 6 caract√®res</div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span class="loading spinner-border spinner-border-sm me-2" role="status"></span>
                Cr√©er l'utilisateur
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">R√©initialiser</button>
        </div>
    </form>
  </div>
</div>

<script>
  const roleSelect = document.getElementById('role');
  const numeroDiv = document.getElementById('numero-div');
  const specialiteDiv = document.getElementById('specialite-div');
  const horairesDiv = document.getElementById('horaires-div');
  const submitBtn = document.getElementById('submitBtn');
  const loadingSpinner = document.querySelector('.loading');
  const alertContainer = document.getElementById('alert-container');

  // Gestion du changement de r√¥le
  roleSelect.addEventListener('change', () => {
    hideAllFields();

    if(roleSelect.value === 'patient') {
      showPatientFields();
    } else if (roleSelect.value === 'medecin') {
      showMedecinFields();
    }
  });

  function hideAllFields() {
    numeroDiv.style.display = 'none';
    specialiteDiv.style.display = 'none';
    horairesDiv.style.display = 'none';

    // D√©sactiver les champs requis
    document.getElementById('numero').required = false;
    document.getElementById('specialite').required = false;
    setTimeInputsRequired(false);
  }

  function showPatientFields() {
    numeroDiv.style.display = 'block';
    document.getElementById('numero').required = true;
  }

  function showMedecinFields() {
    specialiteDiv.style.display = 'block';
    horairesDiv.style.display = 'block';
    document.getElementById('specialite').required = true;
    setTimeInputsRequired(true);
  }

  function setTimeInputsRequired(required) {
    const timeInputs = horairesDiv.querySelectorAll('input[type="time"]');
    timeInputs.forEach(input => {
      input.required = required;
    });
  }

  function addCreneau(day) {
    const dayDiv = document.querySelector(`div[data-day="${day}"] .creneaux`);
    const newCreneau = document.createElement('div');
    newCreneau.classList.add('creneau');
    newCreneau.innerHTML = `
      <input type="time" name="${day}_start[]" class="form-control form-control-sm" required>
      <span>√†</span>
      <input type="time" name="${day}_end[]" class="form-control form-control-sm" required>
      <button type="button" class="btn btn-sm btn-danger" onclick="removeCreneau(this)" title="Supprimer ce cr√©neau">
        ‚ùå
      </button>
    `;
    dayDiv.appendChild(newCreneau);
  }

  function removeCreneau(button) {
    const creneau = button.parentElement;
    const creneauxContainer = creneau.parentElement;

    // Ne pas supprimer s'il n'y a qu'un seul cr√©neau
    if (creneauxContainer.children.length > 1) {
      creneau.remove();
    } else {
      showAlert('Vous devez conserver au moins un cr√©neau par jour.', 'warning');
    }
  }

  function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alertDiv);

    // Auto-hide after 5 seconds
    setTimeout(() => {
      if (alertDiv.parentElement) {
        alertDiv.remove();
      }
    }, 5000);
  }

  function resetForm() {
    document.getElementById('userForm').reset();
    hideAllFields();
    alertContainer.innerHTML = '';
  }

  function validateTimeSlots() {
    if (roleSelect.value !== 'medecin') return true;

    const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
    let hasValidSlot = false;

    for (const day of days) {
      const startInputs = document.querySelectorAll(`input[name="${day}_start[]"]`);
      const endInputs = document.querySelectorAll(`input[name="${day}_end[]"]`);

      for (let i = 0; i < startInputs.length; i++) {
        const start = startInputs[i].value;
        const end = endInputs[i].value;

        if (start && end) {
          hasValidSlot = true;
          if (start >= end) {
            showAlert(`Erreur dans les horaires du ${day}: l'heure de fin doit √™tre apr√®s l'heure de d√©but.`, 'danger');
            return false;
          }
        }
      }
    }

    if (!hasValidSlot) {
      showAlert('Veuillez d√©finir au moins un cr√©neau horaire.', 'danger');
      return false;
    }

    return true;
  }

  // Gestion de la soumission du formulaire
  document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Validation personnalis√©e
    if (!validateTimeSlots()) {
      return;
    }

    // Afficher le loading
    loadingSpinner.style.display = 'inline-block';
    submitBtn.disabled = true;

    const role = roleSelect.value;
    const formData = new FormData(this);
    const json = {};

    // Conversion FormData vers JSON - version corrig√©e
    for (const [key, value] of formData.entries()) {
      // Gestion sp√©ciale pour les tableaux (horaires)
      if (key.endsWith('_start[]') || key.endsWith('_end[]')) {
        const day = key.split('_')[0];
        const type = key.includes('_start[]') ? 'start' : 'end';

        if (!json[day]) {
          json[day] = [];
        }

        // Cr√©er un objet pour chaque cr√©neau s'il n'existe pas encore
        const index = formData.getAll(key).indexOf(value);
        if (!json[day][index]) {
          json[day][index] = {};
        }
        json[day][index][type] = value;
      }
      // Gestion des champs normaux
      else {
        // Si c'est un champ qui peut avoir plusieurs valeurs (comme les cases √† cocher)
        if (json[key] !== undefined) {
          if (!Array.isArray(json[key])) {
            json[key] = [json[key]];
          }
          json[key].push(value);
        } else {
          json[key] = value;
        }
      }
    }

    // Nettoyer les horaires pour les m√©decins
    if (role === 'medecin') {
      const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
      const horaires = {};

      days.forEach(day => {
        if (json[day]) {
          // Filtrer les cr√©neaux valides (avec start et end)
          const validSlots = json[day].filter(slot => slot.start && slot.end);
          if (validSlots.length > 0) {
            horaires[day] = validSlots;
          }
          // Supprimer la cl√© du jour
          delete json[day];
        }
      });

      json.horaires = horaires;
    }

    // Envoi de la requ√™te
    fetch(`/${role}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(json)
    })
    .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || `Erreur HTTP ${response.status}`);
          });
        }
        return response.json();
    })
    .then(data => {
        showAlert(`${role.charAt(0).toUpperCase() + role.slice(1)} cr√©√© avec succ√®s ! ID: ${data.id}`, 'success');
        resetForm();
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert(`Erreur lors de la cr√©ation: ${error.message}`, 'danger');
    })
    .finally(() => {
        // Cacher le loading
        loadingSpinner.style.display = 'none';
        submitBtn.disabled = false;
    });
  });

  // Validation en temps r√©el de l'email
  document.getElementById('email').addEventListener('blur', function() {
    const email = this.value;
    if (email && !email.includes('@')) {
      showAlert('Format d\'email invalide', 'warning');
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>